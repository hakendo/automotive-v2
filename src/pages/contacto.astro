---
import Layout from "../layouts/Layout.astro";

// Clave del sitio hCaptcha
const keyHcaptcha: string = import.meta.env.PUBLIC_HCAPTCHA_SITE_KEY ?? '';
if (!keyHcaptcha) {
    console.warn("Advertencia: Clave hCaptcha (PUBLIC_HCAPTCHA_SITE_KEY) no configurada.");
}

// Tus datos de Automotive Consulting (se mantienen)
const contactDetails = [
  { icon: "fas fa-phone-alt", title: "Llámanos", value: "+56 9 7622 5094", href: "tel:+56976225094", bgColor: "bg-yellow-100", textColor: "text-yellow-600" },
  { icon: "fas fa-envelope", title: "Solange Roco", value: "roco.solange@automotiveconsulting.cl", href: "mailto:roco.solange@automotiveconsulting.cl", bgColor: "bg-blue-100", textColor: "text-blue-600" },
];
const locations = [
    // --- IMPORTANTE: Reemplaza estas URLs con las URLs de Embed correctas de Google Maps ---
    // 1. Ve a Google Maps, busca la dirección.
    // 2. Haz clic en "Compartir" > "Insertar un mapa".
    // 3. Copia la URL que está DENTRO del atributo src="..." y pégala aquí.
    { name: "Sucursal Las Condes", address: "Camino El Alba 8760, of 304, Santiago, Chile.", mapSrc: "URL_DE_EMBED_GOOGLE_MAPS_LAS_CONDES" }, // <-- PEGA AQUÍ LA URL SRC DEL IFRAME
    { name: "Sucursal Macul", address: "Auto Park, Av. Departamental 4400, Santiago, Chile.", mapSrc: "URL_DE_EMBED_GOOGLE_MAPS_MACUL" }, // <-- PEGA AQUÍ LA URL SRC DEL IFRAME
    { name: "Sucursal Viña del Mar", address: "Auto Park, Cam. Internacional 3500, Viña del Mar, Valparaíso, Chile.", mapSrc: "URL_DE_EMBED_GOOGLE_MAPS_VINA" } // <-- PEGA AQUÍ LA URL SRC DEL IFRAME
]
---

<Layout
  title="Contacto - Automotive Consulting"
  description="Escríbenos si tienes alguna duda o si quieres vender tu automovil de forma segura y confiable."
  image="/image-service-01.webp"
>
  <Fragment slot="head">
    {/* Script para manejar envío y validaciones del formulario */}
    <script define:vars={{ keyHcaptcha }}>
      const HCAPTCHA_SRC = 'https://js.hcaptcha.com/1/api.js?render=explicit';

      function loadHcaptcha() {
        if (window.hcaptcha) {
          return Promise.resolve(window.hcaptcha);
        }

        const existingScript = document.querySelector('script[data-hcaptcha-loader="true"]');
        if (existingScript) {
          return new Promise((resolve, reject) => {
            existingScript.addEventListener('load', () => {
              if (window.hcaptcha) {
                resolve(window.hcaptcha);
              } else {
                reject(new Error('hCaptcha failed to initialize after load event.'));
              }
            });
            existingScript.addEventListener('error', () => reject(new Error('Failed to load hCaptcha script')));
          });
        }

        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = HCAPTCHA_SRC;
          script.async = true;
          script.defer = true;
          script.dataset.hcaptchaLoader = 'true';

          script.onload = () => {
            if (window.hcaptcha) {
              resolve(window.hcaptcha);
            } else {
              reject(new Error('hCaptcha failed to load'));
            }
          };

          script.onerror = () => reject(new Error('Failed to load hCaptcha script'));

          document.head.appendChild(script);
        });
      }

      document.addEventListener('DOMContentLoaded', async () => {
        const form = document.getElementById('contact-form');
        const formStatus = document.getElementById('form-status');
        const statusText = formStatus?.querySelector('p');
        const captchaContainer = document.getElementById('captcha-container');

        if (!form || !formStatus || !statusText || !captchaContainer) {
          console.error('Error: Elementos del formulario no encontrados.');
          return;
        }

        let hcaptchaWidgetId = null;

        function disableFormControls(disabled) {
          form.querySelectorAll('input, textarea, button').forEach((el) => {
            if (disabled) {
              el.setAttribute('disabled', 'true');
            } else {
              el.removeAttribute('disabled');
            }
          });
        }

        function showStatus(message, type = 'info') {
          if (!formStatus || !statusText) return;

          formStatus.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100');
          statusText.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');

          const bgClass = type === 'success' ? 'bg-green-100' : type === 'error' ? 'bg-red-100' : 'bg-blue-100';
          const textClass = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';

          formStatus.classList.add(bgClass);
          statusText.classList.add(textClass);
          statusText.textContent = message;
        }

        if (!keyHcaptcha) {
          console.error('Error: Falta la clave pública de hCaptcha (PUBLIC_HCAPTCHA_SITE_KEY).');
          disableFormControls(true);
          showStatus('No se pudo cargar la verificación de seguridad. Intenta nuevamente más tarde.', 'error');
          return;
        }

        try {
          const hcaptcha = await loadHcaptcha();
          hcaptchaWidgetId = hcaptcha.render(captchaContainer, {
            sitekey: keyHcaptcha,
            theme: 'light',
            size: 'normal'
          });
        } catch (error) {
          console.error('Error loading hCaptcha:', error);
          captchaContainer.innerHTML = '<p class="text-red-600 text-center">Error al cargar el captcha. Por favor, recarga la página.</p>';
          return;
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!form.checkValidity()) {
            form.reportValidity();
            showStatus('Por favor, completa todos los campos correctamente.', 'error');
            return;
          }

          const hcaptchaResponse = window.hcaptcha?.getResponse(hcaptchaWidgetId ?? undefined);
          if (!hcaptchaResponse) {
            showStatus('Por favor, completa la verificación de seguridad.', 'error');
            return;
          }

          const formData = new FormData(form);
          const payload = Object.fromEntries(formData.entries());
          payload['h-captcha-response'] = hcaptchaResponse;

          const submitButton = form.querySelector('button[type="submit"]');
          const originalText = submitButton ? submitButton.textContent : '';
          disableFormControls(true);
          if (submitButton) submitButton.textContent = 'Enviando...';
          showStatus('Enviando mensaje...', 'info');

          try {
            const fetchResponse = await fetch('/api/send-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const result = await fetchResponse.json().catch(() => ({ success: false, message: 'Respuesta inválida del servidor.' }));

            if (!fetchResponse.ok || !result.success) {
              throw new Error(result.message || `Error del servidor (${fetchResponse.status})`);
            }

            form.reset();
            if (typeof window.hcaptcha?.reset === 'function') {
              window.hcaptcha.reset(hcaptchaWidgetId ?? undefined);
            }
            showStatus('¡Mensaje enviado con éxito! Te contactaremos pronto.', 'success');
            setTimeout(() => {
              formStatus.classList.add('hidden');
            }, 5000);
          } catch (error) {
            console.error('Error al enviar formulario:', error);
            const errorMessage = error instanceof Error ? error.message : 'Intenta nuevamente.';
            showStatus(`Error: ${errorMessage}`, 'error');
          } finally {
            disableFormControls(false);
            if (submitButton) submitButton.textContent = originalText;
          }
        });
      });
    </script>
  </Fragment>
  
  <section class="bg-white py-24 pt-48">
    <div class="md:w-7xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Hablemos</h1>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Escríbenos si tienes alguna duda o si quieres vender tu automóvil de forma segura y confiable con nosotros.
      </p>
    </div>
  </section>

  <main class="bg-gray-50 py-16 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 mb-20">
        {/* --- Columna Izquierda: Formulario --- */}
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-8 md:p-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-6">Envíanos un mensaje</h2>
          <form id="contact-form" class="space-y-6">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-semibold text-gray-900 mb-2">Nombre</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        required 
                        minlength="2"
                        placeholder="Tu nombre completo" 
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00B4D8] transition-all"
                    />
                </div>
                <div>
                    <label for="phone" class="block text-sm font-semibold text-gray-900 mb-2">Teléfono</label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone" 
                        required 
                        placeholder="+56 9 1234 5678" 
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00B4D8] transition-all"
                    />
                </div>
             </div>
             <div>
                <label for="email" class="block text-sm font-semibold text-gray-900 mb-2">Email</label>
                    <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    required 
                    placeholder="tu@email.com" 
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00B4D8] transition-all"
                />
             </div>
             <div>
                <label for="message" class="block text-sm font-semibold text-gray-900 mb-2">Mensaje</label>
                <textarea 
                    id="message" 
                    name="message" 
                    rows="5" 
                    required 
                    minlength="10"
                    maxlength="1000"
                    placeholder="Escribe tu mensaje..." 
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00B4D8] transition-all resize-none"
                ></textarea>
             </div>

            {/* Widget hCaptcha */}
            <div class="w-full">
              <div class="flex justify-center w-full" id="captcha-container"></div>
            </div>
            {/* Mensaje de Estado */}
            <div id="form-status" class="hidden mt-4 p-4 rounded-lg" aria-live="polite">
              <p class="text-center font-medium"></p>
            </div>
            {/* Botón Submit (color original ac-blue) */}
            <button type="submit" class="w-full bg-[#00B4D8] hover:bg-[#0096c7] text-white font-bold py-4 px-8 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-[#00B4D8] focus:ring-offset-2 shadow-lg disabled:opacity-50">
              Enviar mensaje
            </button>
          </form>
        </div>

        {/* --- Columna Derecha: Secciones Adicionales (Restauradas) --- */}
        <div class="space-y-8">
            {/* Contacto Directo */}
            <div>
                 <h3 class="text-2xl font-bold text-gray-900 mb-6">Contacto Directo</h3>
                  <div class="space-y-4">
                      {contactDetails.map(item => (
                      <a href={item.href} target="_blank" rel="noopener noreferrer" class="flex items-center space-x-4 bg-white p-4 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                          <div class:list={["flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center", item.bgColor]}> <i class:list={[item.icon, item.textColor, "text-xl"]}></i> </div>
                          <div> <p class="text-sm font-semibold text-gray-900">{item.title}</p> <p class="text-gray-600 text-sm break-all">{item.value}</p> </div>
                      </a>
                      ))}
                  </div>
            </div>
            {/* Por qué elegirnos */}
            <div>
                <h3 class="text-2xl font-bold text-gray-900 mb-6">¿Por qué elegirnos?</h3>
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-center"><i class="fas fa-hand-holding-usd text-ac-blue w-5 text-center mr-3" aria-hidden="true"></i>Crédito automotriz</li>
                    <li class="flex items-center"><i class="fas fa-percentage text-ac-blue w-5 text-center mr-3" aria-hidden="true"></i>La mejor tasa de interés</li>
                    <li class="flex items-center"><i class="fas fa-shield-alt text-ac-blue w-5 text-center mr-3" aria-hidden="true"></i>Garantía</li>
                </ul>
            </div>
        </div>
        {/* --- Fin Columna Derecha --- */}
      </div>

      {/* --- Sucursales (Restauradas) --- */}
      <div class="text-center mb-12 mt-20">
         <h2 class="text-3xl font-bold text-gray-900">Nuestras Sucursales</h2>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
         {locations.map(loc => (
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-1.5 transition-transform duration-300">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">{loc.name}</h3>
                    <p class="text-gray-600 flex items-start"><i class="fas fa-map-marker-alt text-ac-blue mt-1 mr-2"></i>{loc.address}</p>
                </div>
                <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    {/* Renderizado condicional del mapa */}
                    {loc.mapSrc && (loc.mapSrc.startsWith('http') || loc.mapSrc.startsWith('www')) && !loc.mapSrc.includes('URL_DE_EMBED') ? (
                         <iframe src={loc.mapSrc} width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title={`Mapa de ${loc.name}`}></iframe>
                     ) : (
                         <div class="w-full h-[300px] flex items-center justify-center bg-gray-100">
                             <p class="text-gray-500 text-sm px-4 text-center">
                                 {loc.mapSrc.includes('URL_DE_EMBED')
                                    ? `Obtén la URL de "Insertar Mapa" en Google Maps para ${loc.name} y pégala.`
                                    : "URL del mapa inválida."
                                 }
                             </p>
                         </div>
                     )
                    }
                </div>
            </div>
        ))}
      </div>
      {/* --- Fin Sucursales --- */}
    </div>
  </main>
</Layout>