---
import Layout from "../layouts/Layout.astro";

const siteKey = import.meta.env.PUBLIC_HCAPTCHA_SITE_KEY ?? "";

const contactInfo = [
  {
    label: "Central",
    value: "+56 9 7622 5094",
    href: "tel:+56976225094",
    icon: "fas fa-phone",
  },
  {
    label: "Correo",
    value: "roco.solange@automotiveconsulting.cl",
    href: "mailto:roco.solange@automotiveconsulting.cl",
    icon: "fas fa-envelope",
  },
  {
    label: "WhatsApp",
    value: "Chat inmediato",
    href: "https://wa.me/56976225094",
    icon: "fab fa-whatsapp",
  },
];
---

<Layout
  title="Contacto | Automotive Consulting"
  description="Escríbenos y agenda una asesoría con Automotive Consulting."
  image="/image-service-01.webp"
>
  <Fragment slot="head">
    <script define:vars={{ siteKey }}>
      const HCAPTCHA_SRC = "https://js.hcaptcha.com/1/api.js?render=explicit";

      const loadHcaptcha = () => {
        if (window.hcaptcha) return Promise.resolve(window.hcaptcha);
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = HCAPTCHA_SRC;
          script.async = true;
          script.defer = true;
          script.onload = () =>
            window.hcaptcha ? resolve(window.hcaptcha) : reject(new Error("hCaptcha no disponible"));
          script.onerror = () => reject(new Error("No pudimos cargar hCaptcha"));
          document.head.appendChild(script);
        });
      };

      const toggleDisabled = (form, disabled) => {
        form.querySelectorAll("input, textarea, button").forEach((el) => {
          if (disabled) {
            el.setAttribute("disabled", "true");
          } else {
            el.removeAttribute("disabled");
          }
        });
      };

      const setStatus = (element, message, type) => {
        if (!element) return;
        element.classList.remove("hidden", "bg-blue-50", "bg-green-50", "bg-red-50", "text-blue-700", "text-green-700", "text-red-700", "border-blue-200", "border-green-200", "border-red-200");

        const typeToClasses = {
          info: ["bg-blue-50", "text-blue-700", "border-blue-200"],
          success: ["bg-green-50", "text-green-700", "border-green-200"],
          error: ["bg-red-50", "text-red-700", "border-red-200"],
        };

        element.classList.add(...(typeToClasses[type] ?? typeToClasses.info));
        element.querySelector("span").textContent = message;
      };

      document.addEventListener("DOMContentLoaded", async () => {
        const form = document.getElementById("contact-form");
        const statusBox = document.getElementById("form-status");
        const captchaSlot = document.getElementById("captcha-slot");

        if (!form || !statusBox || !captchaSlot) {
          console.error("No se encontró alguno de los elementos del formulario.");
          return;
        }

        if (!siteKey) {
          toggleDisabled(form, true);
          setStatus(
            statusBox,
            "Falta configurar hCaptcha. Revisa la variable PUBLIC_HCAPTCHA_SITE_KEY.",
            "error",
          );
          return;
        }

        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => {
          const field = form.querySelector(`[name="${key}"]`);
          if (field && typeof value === "string") field.value = value;
        });

        let widgetId = null;
        try {
          const hcaptcha = await loadHcaptcha();
          widgetId = hcaptcha.render(captchaSlot, { sitekey: siteKey, size: "normal" });
        } catch (error) {
          console.error("No fue posible inicializar hCaptcha:", error);
          toggleDisabled(form, true);
          setStatus(statusBox, "No pudimos cargar la verificación de seguridad. Inténtalo más tarde.", "error");
          return;
        }

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!form.reportValidity()) return;

          const token = widgetId !== null ? window.hcaptcha?.getResponse(widgetId) : "";
          if (!token) {
            setStatus(statusBox, "Confirma que no eres un robot para continuar.", "error");
            return;
          }

          const data = Object.fromEntries(new FormData(form).entries());
          data["h-captcha-response"] = token;

          toggleDisabled(form, true);
          setStatus(statusBox, "Enviando mensaje...", "info");

          try {
            const response = await fetch("/api/send-email", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json().catch(() => ({
              success: false,
              message: "Respuesta inválida del servidor.",
            }));

            if (!response.ok || result.success === false) {
              throw new Error(result.message ?? "No fue posible enviar tu mensaje.");
            }

            form.reset();
            if (widgetId !== null) window.hcaptcha?.reset(widgetId);
            const name = typeof data.name === "string" ? data.name : "";
            window.location.href = `/gracias?name=${encodeURIComponent(name)}`;
          } catch (error) {
            console.error("Error al enviar el formulario:", error);
            const message =
              error instanceof Error ? error.message : "Intenta nuevamente en unos minutos.";
            setStatus(statusBox, message, "error");
            if (widgetId !== null) window.hcaptcha?.reset(widgetId);
          } finally {
            toggleDisabled(form, false);
          }
        });
      });
    </script>
  </Fragment>

  <section class="bg-gray-900 text-white">
    <div class="max-w-5xl mx-auto px-6 py-20 lg:py-28 flex flex-col gap-10">
      <div class="space-y-4 text-center md:text-left">
        <p class="uppercase tracking-[0.45em] text-sm text-gray-400">Contacto</p>
        <h1 class="text-4xl md:text-5xl font-semibold leading-tight">
          Hablemos de tu próximo automóvil o venta segura
        </h1>
        <p class="text-gray-300 text-lg md:text-xl">
          Completa el formulario y te responderemos en menos de 24 horas hábiles.
        </p>
      </div>

      <div class="grid gap-6 sm:grid-cols-3">
        {contactInfo.map((info) => (
          <a
            href={info.href}
            class="group rounded-2xl border border-white/10 bg-white/5 p-5 transition hover:bg-white/10"
            target={info.href.startsWith("http") ? "_blank" : undefined}
            rel="noreferrer noopener"
          >
            <div class="flex items-center gap-4">
              <span class="flex h-12 w-12 items-center justify-center rounded-full bg-white/10 text-lg text-teal-300 group-hover:bg-white/20">
                <i class={info.icon}></i>
              </span>
              <div>
                <p class="text-xs uppercase tracking-[0.35em] text-gray-400">{info.label}</p>
                <p class="text-lg font-semibold text-white">{info.value}</p>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <section class="bg-white">
    <div class="max-w-5xl mx-auto px-6 py-16 lg:py-20">
      <div class="grid gap-16 lg:grid-cols-2">
        <form id="contact-form" class="space-y-6 rounded-2xl border border-gray-100 p-8 shadow-lg">
          <div class="space-y-3">
            <h2 class="text-3xl font-semibold text-gray-900">Envíanos un mensaje</h2>
            <p class="text-gray-600">
              Todos los campos son obligatorios para poder atenderte correctamente.
            </p>
          </div>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Nombre completo
            <input
              type="text"
              name="name"
              required
              minlength="2"
              autocomplete="name"
              placeholder="Ej. Matías Aravena"
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Teléfono
            <input
              type="tel"
              name="phone"
              required
              autocomplete="tel"
              placeholder="+56 9 1234 5678"
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Correo electrónico
            <input
              type="email"
              name="email"
              required
              autocomplete="email"
              placeholder="nombre@empresa.cl"
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400"
            />
          </label>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Mensaje
            <textarea
              name="message"
              rows="5"
              required
              minlength="10"
              maxlength="1200"
              placeholder="Cuéntanos cómo podemos ayudarte."
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400 resize-none"
            ></textarea>
          </label>

          <div class="space-y-4">
            <div id="captcha-slot" class="flex justify-center"></div>
            <div
              id="form-status"
              class="hidden rounded-xl border px-4 py-3 text-sm font-medium"
              aria-live="polite"
            >
              <span></span>
            </div>
          </div>

          <button
            type="submit"
            class="w-full rounded-xl bg-teal-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-teal-400 focus:outline-none focus:ring-4 focus:ring-teal-200"
          >
            Enviar mensaje
          </button>
        </form>

        <div class="space-y-8">
          <div class="space-y-4">
            <h3 class="text-2xl font-semibold text-gray-900">¿Qué pasa después?</h3>
            <ul class="space-y-3 text-gray-600">
              <li>• Revisamos tu mensaje y te respondemos en menos de 24 horas hábiles.</li>
              <li>• Coordinamos una llamada o visita según tu preferencia.</li>
              <li>• Acompañamos todo el proceso de compra o venta de tu vehículo.</li>
            </ul>
          </div>

          <div class="space-y-4 rounded-2xl bg-gray-50 p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900">Visítanos</h3>
            <p class="text-gray-600">Camino El Alba 8760, oficina 304, Las Condes.</p>
            <p class="text-gray-600">Horarios: Lunes a Viernes, 09:00 - 19:00 hrs.</p>
            <a
              href="https://maps.google.com/?q=Camino+El+Alba+8760,+Las+Condes"
              target="_blank"
              rel="noreferrer noopener"
              class="inline-flex items-center gap-2 text-teal-600 font-medium hover:text-teal-500"
            >
              <i class="fas fa-map-marker-alt"></i> Abrir en Google Maps
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
