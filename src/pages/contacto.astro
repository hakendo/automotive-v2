---
import Layout from "../layouts/Layout.astro";

// Access key de Web3Forms
const WEB3FORMS_ACCESS_KEY = import.meta.env.KEY_WEB3FORMS ?? "";

const contactInfo = [
  {
    label: "Central",
    value: "+56 9 7622 5094",
    href: "tel:+56976225094",
    icon: "fas fa-phone",
  },
  {
    label: "Correo",
    value: "roco.solange@automotiveconsulting.cl",
    href: "mailto:roco.solange@automotiveconsulting.cl",
    icon: "fas fa-envelope",
  },
  {
    label: "WhatsApp",
    value: "Chat inmediato",
    href: "https://wa.me/56976225094",
    icon: "fab fa-whatsapp",
  },
];

const branchLocations = [
  {
    name: "Sucursal Las Condes",
    address: "Camino El Alba 8760, Oficina 304, Las Condes.",
    mapSrc:
      "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3328.357728379575!2d-70.54422302456122!3d-33.45984497338318!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9662cf1d36e4c7ed%3A0xbb5f9f4829b69f64!2sCam.%20El%20Alba%208760%2C%20Las%20Condes%2C%20Regi%C3%B3n%20Metropolitana%2C%20Chile!5e0!3m2!1ses-419!2scl!4v1730400000000!5m2!1ses-419!2scl",
  },
  {
    name: "Sucursal Macul",
    address: "Auto Park, Av. Departamental 4400, Macul.",
    mapSrc:
      "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3331.122931836431!2d-70.59326312456411!3d-33.393758972863955!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9662cff1b982d7db%3A0x963c27d9c95605b4!2sAv.%20Departamental%204400%2C%20Macul%2C%20Regi%C3%B3n%20Metropolitana%2C%20Chile!5e0!3m2!1ses-419!2scl!4v1730400000001!5m2!1ses-419!2scl",
  },
  {
    name: "Sucursal Viña del Mar",
    address: "Camino Internacional 3500, Viña del Mar.",
    mapSrc:
      "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3332.974939073879!2d-71.54062702456599!3d-33.34842647251844!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9689debf5d61c0ff%3A0x9ed0b9b0f2745078!2sCam.%20Internacional%203500%2C%20Vi%C3%B1a%20del%20Mar%2C%20Valpara%C3%ADso%2C%20Chile!5e0!3m2!1ses-419!2scl!4v1730400000002!5m2!1ses-419!2scl",
  },
];
---

<Layout
  title="Contacto | Automotive Consulting"
  description="Escríbenos y agenda una asesoría con Automotive Consulting."
  image="/image-service-01.webp"
>
  <Fragment slot="head">
    <script define:vars={{ accessKey: WEB3FORMS_ACCESS_KEY }}>
      const WEB3FORMS_ENDPOINT = "https://api.web3forms.com/submit";
      const isDev = import.meta.env.DEV;

      // Utilidad para logging condicional
      const log = (...args) => {
        if (isDev) console.log(...args);
      };
      const logError = (...args) => {
        if (isDev) console.error(...args);
      };

      // Función para deshabilitar/habilitar el formulario
      const toggleDisabled = (form, disabled) => {
        if (!form) return;
        const elements = form.querySelectorAll("input, textarea, button");
        elements.forEach((el) => {
          if (disabled) {
            el.setAttribute("disabled", "true");
            el.setAttribute("aria-disabled", "true");
          } else {
            el.removeAttribute("disabled");
            el.removeAttribute("aria-disabled");
          }
        });
      };

      // Función para mostrar estados del formulario
      const setStatus = (element, message, type) => {
        if (!element) return;
        
        // Limpiar clases anteriores
        element.classList.remove(
          "hidden",
          "bg-blue-50",
          "bg-green-50",
          "bg-red-50",
          "text-blue-700",
          "text-green-700",
          "text-red-700",
          "border-blue-200",
          "border-green-200",
          "border-red-200"
        );

        const typeToClasses = {
          info: ["bg-blue-50", "text-blue-700", "border-blue-200"],
          success: ["bg-green-50", "text-green-700", "border-green-200"],
          error: ["bg-red-50", "text-red-700", "border-red-200"],
        };

        element.classList.add(...(typeToClasses[type] ?? typeToClasses.info));
        const textNode = element.querySelector("span");
        if (textNode) {
          textNode.textContent = message;
        }
        
        // Scroll suave al mensaje de estado
        element.scrollIntoView({ behavior: "smooth", block: "nearest" });
      };

      // Validación mejorada de email
      const isValidEmail = (email) => {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      };

      // Validación mejorada de teléfono (formato chileno)
      const isValidPhone = (phone) => {
        // Acepta formatos: +56912345678, 56912345678, 912345678, etc.
        const phoneRegex = /^(\+?56)?[9]\d{8}$/;
        const cleaned = phone.replace(/\s|-|\(|\)/g, "");
        return phoneRegex.test(cleaned);
      };

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("contact-form");
        const statusBox = document.getElementById("form-status");
        const submitButton = form?.querySelector('button[type="submit"]');

        if (!form || !statusBox) {
          logError("No se encontraron los elementos del formulario.");
          return;
        }

        // Prellenar campos desde URL params (útil para tracking)
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => {
          const field = form.querySelector(`[name="${key}"]`);
          if (field && typeof value === "string") {
            field.value = decodeURIComponent(value);
          }
        });

        const showStatus = (message, type) => setStatus(statusBox, message, type);

        // Validación en tiempo real
        const nameInput = form.querySelector('[name="name"]');
        const emailInput = form.querySelector('[name="email"]');
        const phoneInput = form.querySelector('[name="phone"]');
        const messageInput = form.querySelector('[name="message"]');

        // Validación de email
        emailInput?.addEventListener("blur", () => {
          const email = emailInput.value.trim();
          if (email && !isValidEmail(email)) {
            emailInput.setCustomValidity("Por favor, ingresa un correo electrónico válido.");
            emailInput.classList.add("border-red-300");
          } else {
            emailInput.setCustomValidity("");
            emailInput.classList.remove("border-red-300");
          }
        });

        // Validación de teléfono
        phoneInput?.addEventListener("blur", () => {
          const phone = phoneInput.value.trim();
          if (phone && !isValidPhone(phone)) {
            phoneInput.setCustomValidity("Por favor, ingresa un teléfono válido (ej: +56 9 1234 5678).");
            phoneInput.classList.add("border-red-300");
          } else {
            phoneInput.setCustomValidity("");
            phoneInput.classList.remove("border-red-300");
          }
        });

        // Limpiar clases de error al escribir
        [nameInput, emailInput, phoneInput, messageInput].forEach((input) => {
          input?.addEventListener("input", () => {
            input.classList.remove("border-red-300");
            input.setCustomValidity("");
          });
        });

        // Manejo del envío del formulario
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          
          // Validación HTML5 nativa
          if (!form.reportValidity()) {
            showStatus("Por favor, completa todos los campos correctamente.", "error");
            return;
          }

          // Validaciones adicionales
          const formData = new FormData(form);
          const name = formData.get("name")?.toString().trim() || "";
          const email = formData.get("email")?.toString().trim() || "";
          const phone = formData.get("phone")?.toString().trim() || "";
          const message = formData.get("message")?.toString().trim() || "";

          if (name.length < 2) {
            showStatus("El nombre debe tener al menos 2 caracteres.", "error");
            nameInput?.focus();
            return;
          }

          if (!isValidEmail(email)) {
            showStatus("Por favor, ingresa un correo electrónico válido.", "error");
            emailInput?.focus();
            return;
          }

          if (!isValidPhone(phone)) {
            showStatus("Por favor, ingresa un teléfono válido (ej: +56 9 1234 5678).", "error");
            phoneInput?.focus();
            return;
          }

          if (message.length < 10) {
            showStatus("El mensaje debe tener al menos 10 caracteres.", "error");
            messageInput?.focus();
            return;
          }

          // Deshabilitar formulario durante el envío
          toggleDisabled(form, true);
          const originalButtonText = submitButton?.textContent || "Enviar mensaje";
          if (submitButton) {
            submitButton.textContent = "Enviando...";
            submitButton.setAttribute("aria-busy", "true");
          }
          showStatus("Enviando mensaje...", "info");

          try {
            // Preparar datos para Web3Forms
            const payload = {
              access_key: accessKey,
              subject: `Nuevo mensaje de contacto - ${name}`,
              from_name: name,
              email: email,
              phone: phone,
              message: message,
              // Campos adicionales para mejor organización
              form_name: "Contacto - Automotive Consulting",
              // Prevenir spam
              botcheck: "",
            };

            log("Enviando formulario a Web3Forms:", payload);

            const response = await fetch(WEB3FORMS_ENDPOINT, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(
                result.message || "No se pudo enviar tu mensaje. Por favor, intenta nuevamente."
              );
            }

            log("Formulario enviado exitosamente:", result);

            // Mostrar mensaje de éxito
            showStatus("¡Mensaje enviado exitosamente! Te responderemos pronto.", "success");

            // Redirigir después de 2 segundos
            setTimeout(() => {
              window.location.href = `/gracias?name=${encodeURIComponent(name)}`;
            }, 2000);
          } catch (error) {
            logError("Error al enviar el formulario:", error);
            showStatus(
              error instanceof Error
                ? error.message
                : "Ocurrió un error al enviar tu mensaje. Por favor, intenta nuevamente o contáctanos directamente.",
              "error"
            );
            toggleDisabled(form, false);
            if (submitButton) {
              submitButton.textContent = originalButtonText;
              submitButton.removeAttribute("aria-busy");
            }
          }
        });
      });
    </script>
  </Fragment>

  <section class="bg-gray-900 text-white">
    <div class="max-w-5xl mx-auto px-6 py-20 lg:py-28 flex flex-col gap-10">
      <div class="space-y-4 text-center md:text-left">
        <p class="uppercase tracking-[0.45em] text-sm text-gray-400">Contacto</p>
        <h1 class="text-4xl md:text-5xl font-semibold leading-tight">
          Hablemos de tu próximo automóvil o venta segura
        </h1>
        <p class="text-gray-300 text-lg md:text-xl">
          Completa el formulario y te responderemos en menos de 24 horas hábiles.
        </p>
      </div>
    </div>
  </section>

  <section class="bg-white">
    <div class="max-w-5xl mx-auto px-6 py-16 lg:py-20">
      <div class="grid gap-16 lg:grid-cols-2">
        <form
          id="contact-form"
          method="POST"
          action="https://api.web3forms.com/submit"
          class="space-y-6 rounded-2xl border border-gray-100 p-8 shadow-lg"
          novalidate
        >
          <div class="space-y-3">
            <h2 class="text-3xl font-semibold text-gray-900">Envíanos un mensaje</h2>
            <p class="text-gray-600">
              Todos los campos son obligatorios para poder atenderte correctamente.
            </p>
          </div>

          <!-- Campo oculto para access key -->
          <input type="hidden" name="access_key" value={WEB3FORMS_ACCESS_KEY} />
          <input type="hidden" name="subject" value="Nuevo mensaje de contacto - Automotive Consulting" />
          <input type="hidden" name="form_name" value="Contacto - Automotive Consulting" />
          <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Nombre completo
            <input
              type="text"
              name="name"
              required
              minlength="2"
              maxlength="100"
              autocomplete="name"
              placeholder="Ej. Juan Pérez"
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400 focus:outline-none"
              aria-required="true"
              aria-describedby="name-error"
            />
            <span id="name-error" class="text-red-600 text-xs hidden" role="alert"></span>
          </label>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Teléfono
            <input
              type="tel"
              name="phone"
              required
              autocomplete="tel"
              placeholder="+56 9 1234 5678"
              pattern="^(\+?56)?[9]\d{8}$"
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400 focus:outline-none"
              aria-required="true"
              aria-describedby="phone-error"
            />
            <span id="phone-error" class="text-red-600 text-xs hidden" role="alert"></span>
            <span class="text-xs text-gray-500">Formato: +56 9 1234 5678</span>
          </label>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Correo electrónico
            <input
              type="email"
              name="email"
              required
              autocomplete="email"
              placeholder="nombre@empresa.cl"
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400 focus:outline-none"
              aria-required="true"
              aria-describedby="email-error"
            />
            <span id="email-error" class="text-red-600 text-xs hidden" role="alert"></span>
          </label>

          <label class="flex flex-col gap-2 text-sm font-medium text-gray-800">
            Mensaje
            <textarea
              name="message"
              rows="5"
              required
              minlength="10"
              maxlength="1200"
              placeholder="Cuéntanos cómo podemos ayudarte."
              class="rounded-xl border border-gray-200 px-4 py-3 text-gray-900 transition focus:border-transparent focus:ring-2 focus:ring-teal-400 resize-none focus:outline-none"
              aria-required="true"
              aria-describedby="message-error"
            ></textarea>
            <span id="message-error" class="text-red-600 text-xs hidden" role="alert"></span>
            <span class="text-xs text-gray-500">Mínimo 10 caracteres, máximo 1200</span>
          </label>

          <div
            id="form-status"
            class="hidden rounded-xl border px-4 py-3 text-sm font-medium"
            aria-live="polite"
            role="alert"
          >
            <span></span>
          </div>

          <button
            type="submit"
            class="w-full rounded-xl bg-teal-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-teal-400 focus:outline-none focus:ring-4 focus:ring-teal-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-teal-500"
            aria-label="Enviar mensaje de contacto"
          >
            Enviar mensaje
          </button>
        </form>

        <div class="space-y-8">
          <div class="space-y-4">
            <h3 class="text-2xl font-semibold text-gray-900">¿Qué pasa después?</h3>
            <ul class="space-y-3 text-gray-600">
              <li class="flex items-start gap-2">
                <span class="text-teal-500 mt-1">✓</span>
                <span>Revisamos tu mensaje y te respondemos en menos de 24 horas hábiles.</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-teal-500 mt-1">✓</span>
                <span>Coordinamos una llamada o visita según tu preferencia.</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-teal-500 mt-1">✓</span>
                <span>Acompañamos todo el proceso de compra o venta de tu vehículo.</span>
              </li>
            </ul>
          </div>

          <div class="space-y-4 rounded-2xl bg-gray-50 p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900">Visítanos</h3>
            <p class="text-gray-600">Camino El Alba 8760, oficina 304, Las Condes.</p>
            <p class="text-gray-600">Horarios: Lunes a Viernes, 09:00 - 19:00 hrs.</p>
            <a
              href="https://maps.google.com/?q=Camino+El+Alba+8760,+Las+Condes"
              target="_blank"
              rel="noreferrer noopener"
              class="inline-flex items-center gap-2 text-teal-600 font-medium hover:text-teal-500 transition-colors"
            >
              <i class="fas fa-map-marker-alt"></i> Abrir en Google Maps
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-gray-50">
    <div class="max-w-6xl mx-auto px-6 py-20 space-y-10">
      <div class="text-center space-y-3">
        <p class="text-sm uppercase tracking-[0.45em] text-gray-500">Sucursales</p>
        <h2 class="text-3xl font-semibold text-gray-900">Visítanos cuando quieras</h2>
        <p class="text-gray-600">
          Elige la sucursal que más te acomode y agenda una reunión con nuestro equipo.
        </p>
      </div>

      <div class="grid gap-8 lg:grid-cols-3">
        {branchLocations.map((branch) => (
          <div class="overflow-hidden rounded-3xl border border-gray-100 bg-white shadow-lg">
            <div class="p-6 space-y-2">
              <h3 class="text-xl font-semibold text-gray-900">{branch.name}</h3>
              <p class="text-gray-600">{branch.address}</p>
            </div>
            <div class="aspect-[4/3] bg-gray-100">
              <iframe
                src={branch.mapSrc}
                loading="lazy"
                allowfullscreen
                referrerpolicy="no-referrer-when-downgrade"
                class="h-full w-full border-0"
                title={`Mapa ${branch.name}`}
              ></iframe>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <section class="bg-gray-900 text-white">
    <div class="max-w-5xl mx-auto px-6 py-16 space-y-6">
      <div class="space-y-2 text-center">
        <p class="text-sm uppercase tracking-[0.45em] text-gray-400">Contacto directo</p>
        <h2 class="text-3xl font-semibold">¿Prefieres hablar de inmediato?</h2>
        <p class="text-gray-300">
          Usa cualquiera de estos canales y coordinaremos contigo el seguimiento.
        </p>
      </div>

      <div class="grid gap-6 sm:grid-cols-3">
        {contactInfo.map((info) => (
          <a
            href={info.href}
            class="group rounded-2xl border border-white/10 bg-white/5 p-5 transition hover:bg-white/10"
            target={info.href.startsWith("http") ? "_blank" : undefined}
            rel="noreferrer noopener"
          >
            <div class="flex items-center gap-4">
              <span class="flex h-12 w-12 items-center justify-center rounded-full bg-white/10 text-lg text-teal-300 group-hover:bg-white/20">
                <i class={info.icon}></i>
              </span>
              <div>
                <p class="text-xs uppercase tracking-[0.35em] text-gray-400">{info.label}</p>
                <p class="text-lg font-semibold text-white">{info.value}</p>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Estilos para campos con error */
  input:invalid:not(:focus):not(:placeholder-shown),
  textarea:invalid:not(:focus):not(:placeholder-shown) {
    border-color: #ef4444;
  }

  /* Animación suave para el estado del formulario */
  #form-status {
    transition: all 0.3s ease-in-out;
  }

  /* Mejora de accesibilidad */
  button:focus-visible {
    outline: 2px solid #14b8a6;
    outline-offset: 2px;
  }
</style>