---
import Layout from "../layouts/Layout.astro";

// Clave del sitio hCaptcha
const keyHcaptcha: string = import.meta.env.PUBLIC_HCAPTCHA_SITE_KEY ?? '';
if (!keyHcaptcha) {
    console.warn("Advertencia: Clave hCaptcha (PUBLIC_HCAPTCHA_SITE_KEY) no configurada.");
}

// Tus datos de Automotive Consulting (se mantienen)
const contactDetails = [
  { icon: "fas fa-phone-alt", title: "Llámanos", value: "+56 9 7622 5094", href: "tel:+56976225094", bgColor: "bg-yellow-100", textColor: "text-yellow-600" },
  { icon: "fas fa-envelope", title: "Solange Roco", value: "roco.solange@automotiveconsulting.cl", href: "mailto:roco.solange@automotiveconsulting.cl", bgColor: "bg-blue-100", textColor: "text-blue-600" },
];
const locations = [
    // --- IMPORTANTE: Reemplaza estas URLs con las URLs de Embed correctas de Google Maps ---
    { name: "Sucursal Las Condes", address: "Camino El Alba 8760, of 304, Santiago, Chile.", mapSrc: "URL_DE_EMBED_GOOGLE_MAPS_LAS_CONDES" }, // <-- PEGA AQUÍ LA URL SRC DEL IFRAME
    { name: "Sucursal Macul", address: "Auto Park, Av. Departamental 4400, Santiago, Chile.", mapSrc: "URL_DE_EMBED_GOOGLE_MAPS_MACUL" }, // <-- PEGA AQUÍ LA URL SRC DEL IFRAME
    { name: "Sucursal Viña del Mar", address: "Auto Park, Cam. Internacional 3500, Viña del Mar, Valparaíso, Chile.", mapSrc: "URL_DE_EMBED_GOOGLE_MAPS_VINA" } // <-- PEGA AQUÍ LA URL SRC DEL IFRAME
]
---

<Layout
  title="Contacto - Automotive Consulting"
  description="Escríbenos si tienes alguna duda o si quieres vender tu automovil de forma segura y confiable."
  image="/image-service-01.webp"
>
  {/* --- INICIO SCRIPT hCaptcha y LÓGICA DE ENVÍO (Estilo Wildcars) --- */}
  <Fragment slot="head">
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script define:vars={{ keyHcaptcha }}>
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('contact-form');
        const formStatus = document.getElementById('form-status');
        const statusText = formStatus?.querySelector('p');

        if (!form || !formStatus || !statusText) {
            console.error("Error: Elementos del formulario no encontrados.");
            return;
        }

        // Verificar si la clave hCaptcha está presente en el cliente
        if (!keyHcaptcha) {
            console.error("La clave del sitio hCaptcha no está disponible.");
            const captchaContainer = document.querySelector('.h-captcha');
            if (captchaContainer) captchaContainer.innerHTML = '<p class="text-red-600 text-center font-medium">Error: Falta configuración de CAPTCHA.</p>';
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const hc = typeof window.hcaptcha !== 'undefined' ? window.hcaptcha : null;
          if (!hc) {
            console.error("Error: hCaptcha no cargado.");
            statusText.textContent = 'Error: El sistema CAPTCHA no cargó. Refresca la página.';
            formStatus.classList.remove('hidden');
            formStatus.className = 'mt-4 text-center font-medium text-red-600';
            return;
          }

          // 1. Obtener token hCaptcha
          const hcaptchaResponse = hc.getResponse();
          if (!hcaptchaResponse) {
            formStatus.classList.remove('hidden');
            statusText.textContent = 'Por favor, completa la verificación de seguridad.';
            statusText.className = 'mt-4 text-center font-medium text-red-600';
            return;
          }

          // 2. Crear objeto JSON (Método Wildcars)
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          data['h-captcha-response'] = hcaptchaResponse; // Añadir token

          // 3. Deshabilitar formulario y mostrar estado
          const submitButton = form.querySelector('button[type="submit"]');
          const originalText = submitButton.textContent;
          form.querySelectorAll('input, textarea, button').forEach(el => el.setAttribute('disabled', 'true'));
          submitButton.textContent = 'Enviando...';
          formStatus.classList.remove('hidden');
          statusText.textContent = 'Enviando mensaje...';
          statusText.className = 'mt-4 text-center font-medium text-gray-600';

          try {
            // 4. Enviar como JSON (Método Wildcars)
            const response = await fetch('/api/send-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (!response.ok || result.success === false) {
              throw new Error(result.message || `Error del servidor (${response.status})`);
            }

            // Éxito
            form.reset();
            hc.reset();
            statusText.textContent = '¡Mensaje enviado con éxito!';
            statusText.className = 'mt-4 text-center font-medium text-green-600';
            setTimeout(() => formStatus.classList.add('hidden'), 5000);

          } catch (error) {
            // Error
            hc.reset();
            console.error("Error al enviar formulario:", error);
            statusText.textContent = `Error: ${error.message || 'Intenta nuevamente.'}`;
            statusText.className = 'mt-4 text-center font-medium text-red-600';
          } finally {
            // Habilitar
            form.querySelectorAll('input, textarea, button').forEach(el => el.removeAttribute('disabled'));
            submitButton.textContent = originalText;
          }
        });
      });
    </script>
  </Fragment>
  {/* --- FIN SCRIPT --- */}

  <section class="bg-white py-24 pt-48">
    <div class="md:w-7xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Hablemos</h1>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Escríbenos si tienes alguna duda o si quieres vender tu automóvil de forma segura y confiable con nosotros.
      </p>
    </div>
  </section>

  <main class="bg-gray-50 py-16 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 mb-20">
        {/* --- Columna Izquierda: Formulario --- */}
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-8 md:p-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-6">Envíanos un mensaje</h2>
          <form id="contact-form" class="space-y-6">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div> <label for="name" class="block text-sm font-semibold text-gray-900 mb-2">Nombre</label> <input type="text" id="name" name="name" required placeholder="Tu nombre" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all"/> </div>
                <div> <label for="phone" class="block text-sm font-semibold text-gray-900 mb-2">Teléfono</label> <input type="tel" id="phone" name="phone" required placeholder="+56 9 1234 5678" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all"/> </div>
             </div>
             <div> <label for="email" class="block text-sm font-semibold text-gray-900 mb-2">Email</label> <input type="email" id="email" name="email" required placeholder="tu@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all"/> </div>
             <div> <label for="message" class="block text-sm font-semibold text-gray-900 mb-2">Mensaje</label> <textarea id="message" name="message" rows="5" required placeholder="Escribe tu mensaje..." class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all resize-none"></textarea> </div>
            {/* Widget hCaptcha */}
            {keyHcaptcha ? (
                <div class="flex justify-center md:justify-start">
                    <div class="h-captcha" data-sitekey={keyHcaptcha}></div>
                </div>
             ) : ( <p class="text-red-600 text-center font-medium">Error: CAPTCHA no configurado.</p> )
            }
            {/* Mensaje de Estado */}
            <div id="form-status" class="hidden mt-4" aria-live="polite"><p class="text-center font-medium"></p></div>
            {/* Botón Submit (color original ac-blue) */}
            <button type="submit" class="w-full bg-ac-blue hover:opacity-90 text-white font-bold py-4 px-8 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-ac-blue focus:ring-offset-2 shadow-lg disabled:opacity-50">
              Enviar mensaje
            </button>
          </form>
        </div>

        {/* --- Columna Derecha: Secciones Adicionales (Restauradas) --- */}
        <div class="space-y-8">
            {/* Contacto Directo */}
            <div>
                 <h3 class="text-2xl font-bold text-gray-900 mb-6">Contacto Directo</h3>
                  <div class="space-y-4">
                      {contactDetails.map(item => (
                      <a href={item.href} target="_blank" rel="noopener noreferrer" class="flex items-center space-x-4 bg-white p-4 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                          <div class:list={["flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center", item.bgColor]}> <i class:list={[item.icon, item.textColor, "text-xl"]}></i> </div>
                          <div> <p class="text-sm font-semibold text-gray-900">{item.title}</p> <p class="text-gray-600 text-sm break-all">{item.value}</p> </div>
                      </a>
                      ))}
                  </div>
            </div>
            {/* Por qué elegirnos */}
            <div>
                <h3 class="text-2xl font-bold text-gray-900 mb-6">¿Por qué elegirnos?</h3>
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-center"><i class="fas fa-hand-holding-usd text-ac-blue w-5 text-center mr-3" aria-hidden="true"></i>Crédito automotriz</li>
                    <li class="flex items-center"><i class="fas fa-percentage text-ac-blue w-5 text-center mr-3" aria-hidden="true"></i>La mejor tasa de interés</li>
                    <li class="flex items-center"><i class="fas fa-shield-alt text-ac-blue w-5 text-center mr-3" aria-hidden="true"></i>Garantía</li>
                </ul>
            </div>
        </div>
        {/* --- Fin Columna Derecha --- */}
      </div>

      {/* --- Sucursales (Restauradas) --- */}
      <div class="text-center mb-12 mt-20">
         <h2 class="text-3xl font-bold text-gray-900">Nuestras Sucursales</h2>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
         {locations.map(loc => (
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-1.5 transition-transform duration-300">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">{loc.name}</h3>
                    <p class="text-gray-600 flex items-start"><i class="fas fa-map-marker-alt text-ac-blue mt-1 mr-2"></i>{loc.address}</p>
                </div>
                <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    {/* Renderizado condicional del mapa */}
                    {loc.mapSrc && (loc.mapSrc.startsWith('http') || loc.mapSrc.startsWith('www')) && !loc.mapSrc.includes('URL_DE_EMBED') ? (
                         <iframe src={loc.mapSrc} width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title={`Mapa de ${loc.name}`}></iframe>
                     ) : (
                         <div class="w-full h-[300px] flex items-center justify-center bg-gray-100">
                             <p class="text-gray-500 text-sm px-4 text-center">
                                 {loc.mapSrc.includes('URL_DE_EMBED')
                                    ? `Obtén la URL de "Insertar Mapa" en Google Maps para ${loc.name} y pégala.`
                                    : "URL del mapa inválida."
                                 }
                             </p>
                         </div>
                     )
                    }
                </div>
            </div>
        ))}
      </div>
      {/* --- Fin Sucursales --- */}
    </div>
  </main>
</Layout>