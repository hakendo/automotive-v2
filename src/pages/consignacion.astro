---
import Layout from "../layouts/Layout.astro";

const recaptchaKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY ?? "";
---

<Layout 
  title="Consigna tu Auto - Automotive Consulting" 
  description="Vende tu auto de forma segura, rápida y al mejor precio del mercado con nuestro servicio de consignación."
>
  <Fragment slot="head">
    {recaptchaKey && <script src="https://www.google.com/recaptcha/api.js" async defer></script>}
    <script define:vars={{ recaptchaKey }}>
      const SUBMIT_ENDPOINT = "/api/contact-submit";

      const toggleDisabled = (form, disabled) => {
        form.querySelectorAll("input, textarea, button").forEach((el) => {
          if (disabled) {
            el.setAttribute("disabled", "true");
          } else {
            el.removeAttribute("disabled");
          }
        });
      };

      const setStatus = (element, message, type) => {
        if (!element) return;
        element.classList.remove(
          "hidden",
          "bg-blue-50",
          "bg-green-50",
          "bg-red-50",
          "text-blue-700",
          "text-green-700",
          "text-red-700",
          "border-blue-200",
          "border-green-200",
          "border-red-200"
        );

        const typeToClasses = {
          info: ["bg-blue-50", "text-blue-700", "border-blue-200"],
          success: ["bg-green-50", "text-green-700", "border-green-200"],
          error: ["bg-red-50", "text-red-700", "border-red-200"],
        };

        element.classList.add(...(typeToClasses[type] ?? typeToClasses.info));
        const textNode = element.querySelector("span");
        if (textNode) textNode.textContent = message;
      };

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("contact-form");
        const statusBox = document.getElementById("form-status");
        if (!form || !statusBox) {
          console.error("No se encontraron los elementos del formulario de consignación.");
          return;
        }

        if (!recaptchaKey) {
          toggleDisabled(form, true);
          setStatus(
            statusBox,
            "Falta configurar reCAPTCHA. Revisa la variable PUBLIC_RECAPTCHA_SITE_KEY.",
            "error"
          );
          return;
        }

        const showStatus = (message, type) => setStatus(statusBox, message, type);

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!form.reportValidity()) return;

          toggleDisabled(form, true);
          showStatus("Verificando seguridad...", "info");

          const recaptcha = window.grecaptcha;
          if (!recaptcha || typeof recaptcha.getResponse !== "function") {
            showStatus("No pudimos cargar reCAPTCHA. Recarga la página.", "error");
            toggleDisabled(form, false);
            return;
          }

          const token = recaptcha.getResponse();
          if (!token) {
            showStatus("Por favor, confirma que no eres un robot.", "error");
            toggleDisabled(form, false);
            return;
          }

          showStatus("Enviando tu solicitud...", "info");

          try {
            const formData = new FormData(form);
            const body = Object.fromEntries(formData.entries());
            body["g-recaptcha-response"] = token;
            body["formType"] = "consignacion";

            const response = await fetch(SUBMIT_ENDPOINT, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });

            if (!response.ok) {
              const error = await response.json().catch(() => null);
              throw new Error(error?.message || "No se pudo enviar tu solicitud.");
            }

            recaptcha.reset();

            const nameField = form.querySelector('[name="name"]');
            const nameValue =
              nameField && "value" in nameField && typeof nameField.value === "string"
                ? nameField.value
                : "";
            window.location.href = `/gracias?name=${encodeURIComponent(nameValue)}`;
          } catch (error) {
            console.error("Error al enviar la solicitud:", error);
            if (typeof recaptcha.reset === "function") recaptcha.reset();
            showStatus(
              error instanceof Error ? error.message : "Intenta nuevamente en unos minutos.",
              "error"
            );
            toggleDisabled(form, false);
          }
        });
      });
    </script>
  </Fragment>
  <section class="bg-gray-900 py-24 pt-48 text-center text-white">
    <div class="md:w-7xl mx-auto px-4">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Consigna tu Auto con Nosotros</h1>
      <p class="text-lg text-gray-300 max-w-3xl mx-auto">
        Vende tu vehículo de forma segura, rápida y al mejor precio del mercado. Nos encargamos de todo el proceso por ti.
      </p>
    </div>
  </section>

  <main class="bg-white py-20 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="bg-gray-50 rounded-2xl shadow-lg p-8 md:p-12">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Ingresa tus datos</h2>
        <p class="text-gray-600 mb-8">Completa el formulario y uno de nuestros expertos te contactará a la brevedad.</p>

        <form
          id="contact-form"
          method="POST"
          class="space-y-6"
        >
          
          <fieldset class="border-t border-gray-200 pt-6">
            <legend class="text-lg font-semibold text-gray-800 mb-4">Tus Datos de Contacto</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                <input type="text" id="name" name="name" required placeholder="Tu nombre completo" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Celular (WhatsApp)</label>
                <input type="tel" id="phone" name="phone" required placeholder="+56 9 1234 5678" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
              </div>
            </div>
            <div class="mt-6">
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" id="email" name="email" required placeholder="tu.correo@ejemplo.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
            </div>
          </fieldset>

          <fieldset class="border-t border-gray-200 pt-6">
            <legend class="text-lg font-semibold text-gray-800 mb-4">Datos de tu Vehículo</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="car-brand" class="block text-sm font-medium text-gray-700 mb-1">Marca</label>
                <input type="text" id="car-brand" name="carBrand" required placeholder="Ej: Toyota" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
              </div>
              <div>
                <label for="car-model" class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                <input type="text" id="car-model" name="carModel" required placeholder="Ej: RAV4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
              </div>
              <div>
                <label for="car-year" class="block text-sm font-medium text-gray-700 mb-1">Año</label>
                <input type="number" id="car-year" name="carYear" required placeholder="Ej: 2022" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
              </div>
              <div>
                <label for="car-mileage" class="block text-sm font-medium text-gray-700 mb-1">Kilometraje</label>
                <input type="number" id="car-mileage" name="carMileage" required placeholder="Ej: 25000" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ac-blue transition-all" />
              </div>
            </div>
          </fieldset>
          
          <div class="flex justify-center">
            {recaptchaKey ? (
              <div class="g-recaptcha" data-sitekey={recaptchaKey}></div>
            ) : (
              <p class="text-sm text-red-500">Configura la clave pública de reCAPTCHA.</p>
            )}
          </div>
          <div
            id="form-status"
            class="hidden rounded-lg border px-4 py-3 text-sm font-medium"
            aria-live="polite"
          >
            <span></span>
          </div>
          <p class="text-xs text-gray-400 text-center">Protegido por reCAPTCHA.</p>
          
          <button type="submit" class="w-full bg-ac-blue hover:opacity-90 text-white font-bold py-4 px-8 rounded-lg transition-all duration-200 transform hover:scale-[1.02] shadow-lg">
            Enviar Solicitud de Consignación
          </button>
        </form>
      </div>
    </div>
  </main>
</Layout>
